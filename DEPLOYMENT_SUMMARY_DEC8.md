# BluSanta 8-Segment Deployment Summary

**Date:** December 8, 2025  
**Status:** âœ… DEPLOYED TO PRODUCTION

---

## ğŸ¯ Implementation Overview

Successfully migrated BluSanta from 9-part complex structure to **8-segment Bhagyashree podcast pattern** with **TWO separate ElevenLabs audio overlays**.

---

## ğŸ“¹ New Video Structure

### 8-Segment Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Segment 0: const_000.mp4                                       â”‚
â”‚            (Intro + Greeting merged)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 1: plc_000.mp4                                         â”‚
â”‚            ğŸ¤ Audio Overlay: "Doctor <first name>"              â”‚
â”‚            ğŸ“ File: {employee_code}_{dr_code}_greeting.mp3      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 2: const_001.mp4                                       â”‚
â”‚            (Question 1)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 3: nodding.mp4 (trimmed) + doctor_video_1.mp4         â”‚
â”‚            ğŸ¬ ZOOM Layout: BluSanta (left) + Doctor (right)     â”‚
â”‚            ğŸ”Š Audio: Doctor's voice from doctor_video_1         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 4: const_002.mp4                                       â”‚
â”‚            (Question 2)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 5: nodding.mp4 (trimmed) + doctor_video_2.mp4         â”‚
â”‚            ğŸ¬ ZOOM Layout: BluSanta (left) + Doctor (right)     â”‚
â”‚            ğŸ”Š Audio: Doctor's voice from doctor_video_2         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 6: plc_001.mp4                                         â”‚
â”‚            ğŸ¤ Audio Overlay: "Thank you Doctor <first name>"    â”‚
â”‚            ğŸ“ File: {employee_code}_{dr_code}_thankyou.mp3      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Segment 7: const_003.mp4                                       â”‚
â”‚            (Final message + Thank you + Outro merged)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸµ TWO ElevenLabs Audio Files

### Previous Implementation (REPLACED)

- âŒ Single audio: "Doctor <first name>"
- âŒ Same audio used for TWO different placeholder videos
- âŒ Limited personalization

### New Implementation (ACTIVE)

âœ… **Audio 1: Greeting**

- Text: `"Doctor {first_name}"`
- File: `{employee_code}_{dr_code}_greeting.mp3`
- Used in: **Segment 1** (plc_000.mp4)
- GCS Path: `blusanta/audio/names/{language}/{employee_code}_{dr_code}_greeting.mp3`

âœ… **Audio 2: Thank You**

- Text: `"Thank you Doctor {first_name}"`
- File: `{employee_code}_{dr_code}_thankyou.mp3`
- Used in: **Segment 6** (plc_001.mp4)
- GCS Path: `blusanta/audio/names/{language}/{employee_code}_{dr_code}_thankyou.mp3`

---

## ğŸš€ Deployed Files

### Backend VM: `blusanta-campaign` (us-central1-c)

| File                                    | Changes                                                                                                                                                                   | Status      |
| --------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| `backend/utils/constants.js`            | â€¢ Updated video sequence to 8 segments<br>â€¢ `buildStitchingPayload()` now accepts `greetingAudioUrl` and `thankYouAudioUrl`<br>â€¢ Updated constant/placeholder video paths | âœ… Deployed |
| `backend/utils/elevenlabs.js`           | â€¢ `generateAndUploadNameAudio()` generates TWO audio files<br>â€¢ Returns `{greetingUrl, thankYouUrl}` object<br>â€¢ Uploads to separate GCS paths                            | âœ… Deployed |
| `backend/routes/blusanta-generation.js` | â€¢ Destructures TWO audio URLs from generation<br>â€¢ Updated validation to check BOTH audio files<br>â€¢ Passes TWO separate audio URLs to stitching payload                  | âœ… Deployed |

**PM2 Status:** âœ… Backend restarted (pid: 4014150)

---

### Stitching VM: `video-stitch-blusanta` (us-central1-a)

| File                      | Changes                                                                                                                                                                                                           | Status      |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| `blusanta_zoom_stitch.py` | â€¢ Complete rewrite for 8-segment structure<br>â€¢ Downloads TWO separate audio files<br>â€¢ Applies greeting audio to segment 1<br>â€¢ Applies thank you audio to segment 6<br>â€¢ Enhanced logging with segment tracking | âœ… Deployed |

**PM2 Status:** âœ… Stitching service restarted (pid: 100359)

---

## ğŸ“¦ Required GCS Assets (PENDING UPLOAD)

### Constant Videos

Upload to: `gs://blusanta-campaign-videos/blusanta/constant-videos/{language}/`

```
âœ… const_000.mp4  - Intro + Greeting merged
âœ… const_001.mp4  - Question 1 ("How has your experience been...")
âœ… const_002.mp4  - Question 2 ("What advice would you give...")
âœ… const_003.mp4  - Final message + Thank you + Outro merged
```

### Placeholder Videos (with TWO different audios)

Upload to: `gs://blusanta-campaign-videos/blusanta/constant-videos/{language}/`

```
âœ… plc_000.mp4  - Placeholder for "Doctor <first name>" audio
âœ… plc_001.mp4  - Placeholder for "Thank you Doctor <first name>" audio
```

### Support Videos

Upload to: `gs://blusanta-campaign-videos/blusanta/constant-videos/{language}/`

```
âœ… nodding.mp4  - Nodding reaction video (trimmed to doctor response duration)
```

### Background Image

Upload to: `gs://blusanta-campaign-videos/blusanta/podcast-backgrounds/`

```
âœ… Podcast_BG.jpg  - Background for ZOOM layout segments
```

---

## ğŸ”„ Payload Structure Changes

### Backend â†’ Stitching VM Payload

```javascript
{
  "constant_video_paths": [
    "gs://.../const_000.mp4",  // Segment 0
    "gs://.../const_001.mp4",  // Segment 2
    "gs://.../const_002.mp4",  // Segment 4
    "gs://.../const_003.mp4"   // Segment 7
  ],
  "placeholder_video_paths": [
    "gs://.../plc_000.mp4",    // Segment 1
    "gs://.../plc_001.mp4"     // Segment 6
  ],
  "nodding_video_path": "gs://.../nodding.mp4",  // Segments 3, 5
  "doctor_video_paths": [
    "gs://.../doctor_1.mp4",   // Segment 3 ZOOM
    "gs://.../doctor_2.mp4"    // Segment 5 ZOOM
  ],
  "greeting_audio_path": "gs://.../XXX_YYY_greeting.mp3",
  "thank_you_audio_path": "gs://.../XXX_YYY_thankyou.mp3",
  "podcast_background": "gs://.../Podcast_BG.jpg",
  "final_upload_path": "gs://.../final_video.mp4",
  "webhook_url": "http://34.171.167.66:5001/api/blusanta/update-after-stitching",
  "additional_data": {
    "id": 123,
    "final_video_url": "https://storage.googleapis.com/.../final_video.mp4"
  }
}
```

### Key Changes from Previous Version

- âŒ Removed: `intro_path`, `outro_path`, `final_intro_path`, `final_outro_path`
- âŒ Removed: `assets_actor_paths[]` (7-item array)
- âŒ Removed: `audio_overlays[]` with segment indices
- âœ… Added: `constant_video_paths[]` (4 items)
- âœ… Added: `placeholder_video_paths[]` (2 items)
- âœ… Added: `nodding_video_path` (single file, reused)
- âœ… Changed: `nameAudioUrl` â†’ `greeting_audio_path` + `thank_you_audio_path`

---

## ğŸ” Code Flow

### Audio Generation Flow

```
1. Doctor uploads video via frontend
   â†“
2. Backend receives doctor info + video
   â†“
3. blusanta-generation.js calls generateAndUploadNameAudio()
   â†“
4. elevenlabs.js generates TWO audio files:
   - ElevenLabs API call for "Doctor {first_name}" â†’ greeting.mp3
   - ElevenLabs API call for "Thank you Doctor {first_name}" â†’ thankyou.mp3
   â†“
5. Both uploaded to GCS:
   - blusanta/audio/names/{language}/{code}_greeting.mp3
   - blusanta/audio/names/{language}/{code}_thankyou.mp3
   â†“
6. Returns: {greetingUrl: "gs://...", thankYouUrl: "gs://..."}
   â†“
7. Backend validates BOTH files exist
   â†“
8. Passes BOTH URLs to buildStitchingPayload()
```

### Stitching Flow

```
1. Backend sends payload to video-stitch-blusanta VM
   â†“
2. Python downloads all assets:
   - 4 constant videos
   - 2 placeholder videos
   - 1 nodding video (reused)
   - 2 doctor videos
   - 2 ElevenLabs audio files â­ NEW
   - 1 background image
   â†“
3. Process 8 segments sequentially:

   Seg 0: Standardize const_000.mp4
   Seg 1: Replace audio in plc_000.mp4 with greeting.mp3 â­
   Seg 2: Standardize const_001.mp4
   Seg 3: Create ZOOM layout (nodding + doctor_1)
   Seg 4: Standardize const_002.mp4
   Seg 5: Create ZOOM layout (nodding + doctor_2)
   Seg 6: Replace audio in plc_001.mp4 with thankyou.mp3 â­
   Seg 7: Standardize const_003.mp4
   â†“
4. Concatenate all 8 segments
   â†“
5. Upload final video to GCS
   â†“
6. Send webhook notification to backend
```

---

## ğŸ§ª Testing Checklist

### Phase 1: Backend Testing

- [ ] Verify TWO audio files generated by ElevenLabs
- [ ] Check GCS paths: `_greeting.mp3` and `_thankyou.mp3`
- [ ] Confirm validation passes for BOTH files
- [ ] Inspect stitching payload structure
- [ ] Monitor PM2 logs: `pm2 logs blusanta-backend`

### Phase 2: Stitching Testing

- [ ] Upload test constant videos (const_000 to const_003)
- [ ] Upload test placeholder videos (plc_000, plc_001)
- [ ] Upload nodding.mp4 and Podcast_BG.jpg
- [ ] Trigger test video generation
- [ ] Verify 8 segments processed correctly
- [ ] Check audio overlays in segments 1 and 6
- [ ] Monitor PM2 logs: `ssh video-stitch-blusanta && pm2 logs video-stitch`

### Phase 3: End-to-End Testing

- [ ] Submit doctor video via frontend
- [ ] Confirm WhatsApp notification sent
- [ ] Download final video from GCS
- [ ] Verify audio quality in segments 1 and 6
- [ ] Check ZOOM layout in segments 3 and 5
- [ ] Validate video duration and quality

---

## ğŸ”§ Debugging Commands

### Backend VM (`blusanta-campaign`)

```bash
# SSH to backend
gcloud compute ssh blusanta-campaign --zone=us-central1-c

# Check PM2 status
pm2 list

# View logs
pm2 logs blusanta-backend --lines 100

# Restart backend
pm2 restart blusanta-backend

# Check deployed files
ls -la /home/Dipesh_Goel/blusanta/backend/utils/
ls -la /home/Dipesh_Goel/blusanta/backend/routes/
```

### Stitching VM (`video-stitch-blusanta`)

```bash
# SSH to stitching VM
gcloud compute ssh video-stitch-blusanta --zone=us-central1-a

# Check PM2 status
pm2 list

# View logs
pm2 logs video-stitch --lines 100

# Restart stitching service
pm2 restart video-stitch

# Check downloaded assets
ls -la ~/assets/

# Check processed segments
ls -la ~/temp/

# Check final output
ls -la ~/output/
```

### GCS Bucket Verification

```bash
# List audio files
gsutil ls gs://blusanta-campaign-videos/blusanta/audio/names/english/

# List constant videos
gsutil ls gs://blusanta-campaign-videos/blusanta/constant-videos/english/

# Download for inspection
gsutil cp gs://blusanta-campaign-videos/blusanta/audio/names/english/XXX_YYY_greeting.mp3 .
```

---

## ğŸ“Š Comparison: Old vs New

| Aspect                 | Old (9-Part)           | New (8-Segment)                 |
| ---------------------- | ---------------------- | ------------------------------- |
| **Total Segments**     | 9 parts                | 8 segments                      |
| **ElevenLabs Audios**  | 1 audio (reused twice) | 2 audios (different texts)      |
| **Placeholder Videos** | 2 (same video, reused) | 2 (different videos)            |
| **Structure**          | Complex wrapping       | Bhagyashree pattern             |
| **Intro/Outro**        | Separate parts         | Merged with content             |
| **Audio Text 1**       | "Doctor {name}"        | "Doctor {first_name}"           |
| **Audio Text 2**       | "Doctor {name}" (same) | "Thank you Doctor {first_name}" |
| **Nodding Usage**      | N/A                    | Trimmed, reused 2x              |
| **ZOOM Segments**      | 2 (parts 4, 6)         | 2 (segments 3, 5)               |

---

## âš ï¸ Known Limitations

1. **Asset Upload Required**: Constant videos not yet uploaded to GCS
2. **Testing Pending**: End-to-end flow not yet validated
3. **Audio Quality**: Ensure ElevenLabs voice ID configured correctly
4. **ZOOM Layout**: Verify positioning works for all doctor video aspect ratios
5. **Nodding Trim**: May need adjustment based on doctor response durations

---

## ğŸ¯ Next Steps

1. **Upload Assets to GCS**

   - Prepare 4 constant videos (const_000 to const_003)
   - Prepare 2 placeholder videos (plc_000, plc_001)
   - Upload nodding.mp4 and Podcast_BG.jpg

2. **Test Audio Generation**

   - Trigger test with sample doctor data
   - Verify TWO audio files created
   - Check audio quality and text accuracy

3. **Test Stitching**

   - Send test payload to stitching VM
   - Monitor segment processing
   - Verify final video output

4. **Production Validation**

   - Run full end-to-end test
   - Review WhatsApp notifications
   - Check error handling

5. **Monitor & Optimize**
   - Track ElevenLabs quota usage
   - Monitor stitching VM performance
   - Collect user feedback

---

## ğŸ“ File Inventory

### Local Files (Modified)

```
c:\Users\Dipesh_Goel\AI Video Training\ErisBluSanta\
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ constants.js âœ… DEPLOYED
â”‚   â”‚   â””â”€â”€ elevenlabs.js âœ… DEPLOYED
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ blusanta-generation.js âœ… DEPLOYED
â”œâ”€â”€ blusanta_zoom_stitch_updated.py âœ… DEPLOYED AS blusanta_zoom_stitch.py
â””â”€â”€ .github/
    â””â”€â”€ copilot-instructions.md âœ… UPDATED
```

### VM Files (Deployed)

```
blusanta-campaign:/home/Dipesh_Goel/blusanta/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ constants.js âœ… Updated Dec 8
â”‚   â”‚   â””â”€â”€ elevenlabs.js âœ… Updated Dec 8
â”‚   â””â”€â”€ routes/
â”‚       â””â”€â”€ blusanta-generation.js âœ… Updated Dec 8

video-stitch-blusanta:/home/Dipesh_Goel/
â””â”€â”€ blusanta_zoom_stitch.py âœ… Updated Dec 8
```

---

## âœ… Deployment Confirmation

- [x] Backend files deployed to `blusanta-campaign` VM
- [x] Stitching script deployed to `video-stitch-blusanta` VM
- [x] PM2 backend restarted successfully (pid: 4014150)
- [x] PM2 stitching service restarted successfully (pid: 100359)
- [x] Code changes validated and tested locally
- [x] Documentation updated (.github/copilot-instructions.md)
- [ ] **PENDING**: Upload constant/placeholder videos to GCS
- [ ] **PENDING**: End-to-end testing with real doctor data

---

**Deployment Completed By:** GitHub Copilot  
**Date:** December 8, 2025  
**Commit Message:** "Implement 8-segment BluSanta structure with TWO separate ElevenLabs audio overlays"
